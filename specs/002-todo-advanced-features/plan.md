# Implementation Plan: Todo App Advanced Features - Recurring Tasks, Due Dates & Time Reminders

**Branch**: `002-todo-advanced-features` | **Date**: 2025-12-30 | **Spec**: [specs/002-todo-advanced-features/spec.md](../spec.md)
**Input**: Feature specification from `/specs/002-todo-advanced-features/spec.md`

## Summary

Implementation of advanced intelligent features for the Phase I console Todo app: Recurring Tasks with auto-generation of next occurrences, flexible Due Date & Time support with multiple input formats, and Console-based Time Reminders for due soon/overdue tasks. The solution extends the existing Task model with new fields and implements core logic in the TodoManager service with CLI enhancements.

## Technical Context

**Language/Version**: Python 3.13+ (Phase I constraint)
**Primary Dependencies**: datetime, dataclasses, typing (standard library)
**Storage**: In-memory (Phase I constraint - no persistence)
**Testing**: pytest for unit tests
**Target Platform**: Console application, cross-platform
**Project Type**: Single console application
**Performance Goals**: <50ms response time for all operations, <100MB memory usage
**Constraints**: In-memory storage, console-based UI, non-blocking operations for reminder system
**Scale/Scope**: Single user console application, <1000 tasks in memory

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Constitution principles to verify:
- âœ… Zero Manual Coding: All code must be generated by Claude Code after refining specifications
- âœ… Spec-Driven Development: All features must originate from /specs/ and reference Task IDs
- âœ… Reusable Intelligence: At least 3 Agent Skills and 2 Subagents must be created and reused
- âœ… MCP Servers: Follow MCP SDK requirements per phase (I-II: No MCP, III-V: MCP required) - Phase I: No MCP needed
- âœ… Phase Evolution: Follow phase-specific constraints and requirements - Phase I: Pure Python console, in-memory
- âœ… Quality Standards: Clean code, type hints, proper structure per phase
- âœ… Violation Hierarchy: Constitution > Specify > Plan > Tasks

## High-Level Overview

The advanced features will integrate seamlessly with the existing codebase:

1. **Data Model Extension**: The Task dataclass will be extended with due_date, recurrence, is_recurring_template, and recurrence_parent_id fields
2. **Service Logic**: TodoManager will gain new methods for date parsing, recurrence handling, and reminder checking
3. **CLI Enhancements**: Main menu and task operations will be updated to support new features
4. **Reminder System**: Non-blocking periodic check integrated into main loop

## Updated Data Model

The Task model in `src/models/task.py` will be extended with:

```python
from datetime import datetime
from typing import Optional

@dataclass
class Task:
    # Existing fields
    id: int
    title: str
    description: str = ""
    status: str = "pending"
    priority: str = "medium"
    tags: List[str] = field(default_factory=list)
    created_at: datetime = field(default_factory=datetime.now)

    # New fields for advanced features
    due_date: Optional[datetime] = None
    recurrence: Optional[str] = None  # "daily", "weekly", "monthly", "yearly", "every_monday", etc.
    recurrence_parent_id: Optional[int] = None  # For generated instances
    is_recurring_template: bool = False
```

## Component Breakdown

### New/Updated Methods in TodoManager (`src/services/todo_manager.py`)

1. **Date Parsing Methods**:
   - `parse_due_date(self, date_input: str) -> datetime` - Parse various date formats including relative dates
   - `format_due_date(self, date: datetime) -> str` - Format datetime for display

2. **Recurring Tasks Methods**:
   - `generate_next_occurrence(self, task: Task) -> Task` - Calculate next occurrence based on recurrence pattern
   - `get_recurring_tasks(self) -> List[Task]` - Filter recurring templates
   - `get_task_instances(self, parent_id: int) -> List[Task]` - Get all instances of a recurring task

3. **Reminder System Methods**:
   - `check_reminders(self) -> List[Task]` - Find tasks due soon or overdue
   - `is_due_soon(self, task: Task, minutes: int = 15) -> bool` - Check if task is due soon
   - `is_overdue(self, task: Task) -> bool` - Check if task is overdue

4. **Enhanced Task Operations**:
   - `add_task(self, title: str, description: str = "", priority: str = "medium", tags: List[str] = None, due_date: Optional[datetime] = None, recurrence: Optional[str] = None) -> Task`
   - `update_task(self, task_id: int, **kwargs) -> Optional[Task]` - Extended to handle new fields

### Changes in CLI (`src/cli/ui.py`)

1. **New Prompts**:
   - `prompt_for_due_date(self) -> Optional[datetime]` - Handle multiple date input formats
   - `prompt_for_recurrence(self) -> Optional[str]` - Offer recurrence pattern selection

2. **Enhanced Display**:
   - `display_task(self, task: Task)` - Updated to show due dates and recurrence indicators
   - `display_tasks(self, tasks: List[Task], show_header: bool = True)` - Enhanced table with due date column

3. **New Menu Options**:
   - Enhanced "Add Task" flow with due date and recurrence options
   - New "View Overdue/Due Soon" menu option
   - Reminder notification display in main loop

### New Module: `src/utils/date_utils.py`

Separate module for date parsing and recurrence logic:
- `parse_date_string(date_str: str) -> datetime` - Parse various date formats
- `calculate_next_date(current_date: datetime, recurrence_pattern: str) -> datetime` - Calculate next occurrence
- `format_datetime_for_display(dt: datetime) -> str` - Format datetime for UI

## Recurring Tasks Strategy

### Template vs Instance Pattern
- **Recurring Templates**: Tasks with `is_recurring_template=True` serve as templates for generating instances
- **Task Instances**: Generated occurrences with `recurrence_parent_id` pointing to the template
- **Separation**: Templates remain unchanged, instances are created/managed separately

### Supported Recurrence Patterns
- `daily`: Every day
- `weekly`: Every week
- `monthly`: Every month on the same day
- `yearly`: Every year on the same date
- `every_monday`, `every_tuesday`, etc.: Specific day of week

### Flow When Marking Complete
1. User marks recurring task instance as complete
2. TodoManager detects if task is a recurring instance
3. If so, generates next occurrence using `generate_next_occurrence`
4. Adds new instance to task list
5. Shows notification: "Next occurrence created for [date]"

## Due Date Parsing Strategy

### Supported Input Formats
1. **Absolute dates**: "2025-12-31", "2025-12-31 14:30", "Dec 31, 2025"
2. **Relative dates**: "today", "tomorrow", "in 3 days", "next week", "next monday"
3. **Natural language**: "next friday at 3pm", "in 2 days at 10am"

### Parsing Implementation
- Use `dateutil.parser` for flexible parsing of various formats
- Implement custom parser for relative dates ("tomorrow", "in N days")
- Fallback to multiple parsing strategies if primary fails

### Fallback Behavior
- If parsing fails, return user-friendly error message
- Prompt user again with examples of valid formats
- Default to current time if user chooses to skip

## Reminder System Strategy

### Non-blocking Polling
- Integrate reminder check into main CLI loop
- Use time-based checks rather than blocking sleep
- Check every 60 seconds when CLI is active

### Alert Logic
- **Due Soon**: Task due within 15 minutes (`due_date <= now + 15min`)
- **Overdue**: Task due date has passed (`due_date < now`)

### Visual Indicators
- **Due Soon**: â° symbol in task display
- **Overdue**: âŒ symbol in task display
- **Recurring**: ðŸ”„ symbol in task display
- Console beep: `print("\a")` for audible alerts

### Integration with View Tasks
- Highlight due/overdue tasks in task lists
- Show reminder count in main menu
- Display active reminders when viewing tasks

## CLI/User Experience Enhancements

### New Prompts During Add/Update
- "Set due date? (y/n): " â†’ "Enter due date (YYYY-MM-DD, 'tomorrow', 'in 3 days', etc.): "
- "Is this recurring? (y/n): " â†’ Recurrence pattern selection menu

### Enhanced Table Display
```
ID | Priority | Title              | Due                | Tags         | Status     | Recur
1  | ðŸ”¥ High   | Weekly meeting     | 2025-12-30 10:00   | work, team   | â³ Pending  | Weekly ðŸ”„
```

### Example User Flows
1. **Adding Recurring Task**:
   - User selects "Add Task"
   - After entering title/priority, prompted: "Set due date? (y/n)"
   - If yes: "Enter due date: tomorrow at 9am"
   - "Is this recurring? (y/n)": "y"
   - "Select pattern: 1) daily 2) weekly 3) monthly 4) custom": "2"
   - Task created with recurrence pattern

2. **Viewing Reminders**:
   - User sees reminder count in main menu: "3 tasks due soon/overdue"
   - When viewing tasks, due soon tasks highlighted with â°
   - Overdue tasks highlighted with âŒ

## Reusability & Future-Proofing

### MCP Tool Potential
- **Recurrence Generation**: Can become MCP tool `generate_next_occurrence` for Phase III
- **Date Parsing**: Can become MCP tool `parse_date_string` for general use
- **Reminder Check**: Can trigger Kafka events in Phase V for distributed reminder system

### Event-Driven Architecture Preparation
- Reminder system designed to emit events that can be captured by Kafka/Dapr
- Recurrence logic separated to enable event-based task generation
- Date utilities designed for reuse across phases

### Reusable Skills Potential
- **Date Parser Skill**: Parse various date formats across the application
- **Recurrence Engine Skill**: Handle recurrence pattern calculations
- **Reminder Manager Skill**: Check and manage task reminders

## Risks, Edge Cases & Mitigations

### Timezone Assumptions
- **Risk**: Local time assumptions may cause issues in distributed systems
- **Mitigation**: Use local time for Phase I, prepare for UTC in future phases

### Invalid Date Inputs
- **Risk**: User enters invalid date format
- **Mitigation**: Comprehensive validation with helpful error messages and format examples

### Beep Not Working on Some Systems
- **Risk**: Console beep (`\a`) may not work on all terminals
- **Mitigation**: Fallback to visual-only alerts, detect beep capability

### Recurring Task Modification
- **Risk**: What happens when user modifies recurring template vs. instance?
- **Mitigation**: Only allow modification of instances; templates remain unchanged

### Multiple Due Tasks
- **Risk**: Many tasks due at once could overwhelm user
- **Mitigation**: Group similar reminders, limit frequency of alerts

## Testing & Demo Recommendations

### Key Scenarios to Demonstrate
1. **Recurring Task Creation**: Create weekly meeting, verify next occurrence generated on completion
2. **Due Date Parsing**: Show multiple input formats (absolute, relative, natural language)
3. **Reminder System**: Set task for tomorrow, demonstrate due soon/overdue indicators
4. **Integration**: Show all features working together in realistic workflow

### Test Coverage
- Unit tests for date parsing functions
- Integration tests for recurrence generation
- UI tests for CLI enhancements
- Performance tests for reminder system

## Project Structure

### Documentation (this feature)

```text
specs/002-todo-advanced-features/
â”œâ”€â”€ plan.md              # This file (/sp.plan command output)
â”œâ”€â”€ research.md          # Phase 0 output (/sp.plan command)
â”œâ”€â”€ data-model.md        # Phase 1 output (/sp.plan command)
â”œâ”€â”€ quickstart.md        # Phase 1 output (/sp.plan command)
â”œâ”€â”€ contracts/           # Phase 1 output (/sp.plan command)
â””â”€â”€ tasks.md             # Phase 2 output (/sp.tasks command - NOT created by /sp.plan)
```

### Source Code (repository root)

```text
src/
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ task.py          # Extended Task model with due_date, recurrence fields
â”‚   â””â”€â”€ __init__.py
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ todo_manager.py  # Enhanced with date/recurrence/reminder methods
â”‚   â””â”€â”€ __init__.py
â”œâ”€â”€ cli/
â”‚   â”œâ”€â”€ ui.py            # Enhanced CLI with new prompts and displays
â”‚   â””â”€â”€ __init__.py
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ date_utils.py    # Date parsing and recurrence utilities
â”‚   â””â”€â”€ __init__.py
â””â”€â”€ main.py              # Main entry point with reminder integration

tests/
â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ test_date_utils.py
â”‚   â””â”€â”€ test_recurring_tasks.py
â”œâ”€â”€ integration/
â”‚   â””â”€â”€ test_reminder_system.py
â””â”€â”€ contract/
    â””â”€â”€ test_cli_interface.py
```

**Structure Decision**: Single project structure selected to maintain Phase I constraints. New modules added to existing src/ directory with clear separation of concerns: models for data, services for business logic, cli for interface, and utils for shared utilities.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| N/A | N/A | N/A - All constitution principles followed |
